{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лист измерений (Эмульсия по ГОСТ 58952.1-2020)</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Modern Theme CSS -->
    <link rel="stylesheet" href="{% static 'css/modern-theme.css' %}">
    <!-- Measurement Sheets CSS -->
    <link rel="stylesheet" href="{% static 'css/measurement-sheets.css' %}">
</head>
<body>
    <div class="measurement-container">
        <!-- Page Header -->
        <div class="measurement-header">
            <h1>
                <i class="bi bi-droplet"></i>
                Лист измерений (Эмульсия {% if sample.mix %}{{ sample.mix.name }}{% else %}ЭБДК В{% endif %} по ГОСТ 58952.1-2020)
            </h1>
            <p class="measurement-subtitle">
                Образец № {{ sample.sample_number }} | Дата поступления: {{ sample.received_date|date:'d.m.Y' }}
            </p>
        </div>
        
        <!-- Диагностическая информация (скрыта по умолчанию) -->
        <div id="debug-info" class="debug-info no-print" style="display: none;">
            <strong>Диагностическая информация:</strong><br>
            Образец ID: {{ sample.id }}<br>
            Тип эмульсии: {% if sample.mix %}{{ sample.mix.name }}{% else %}ЭБДК В{% endif %}<br>
            EmulsionTestResult ID: {% if test_result.id %}{{ test_result.id }}{% else %}Новый{% endif %}<br>
            JavaScript файл: emulsion_58952_calculations.js<br>
            <button type="button" onclick="document.getElementById('debug-info').style.display='none'" class="debug-close-btn">Скрыть</button>
        </div>
        
        <!-- Sample Info -->
        <table class="info-table">
            <tr>
                <td><i class="bi bi-hash"></i> Номер:</td>
                <td><input type="text" value="{{ sample.sample_number }}" readonly></td>
            </tr>
            <tr>
                <td><i class="bi bi-calendar-event"></i> Дата отбора:</td>
                <td><input type="text" value="{{ sample.sampling_date|date:'d.m.Y' }}" readonly></td>
            </tr>
            <tr>
                <td><i class="bi bi-person-badge"></i> Заказчик:</td>
                <td><input type="text" value="{{ sample.customer }}" readonly></td>
            </tr>
            <tr>
                <td><i class="bi bi-calendar-check"></i> Дата поступления в лабораторию:</td>
                <td><input type="text" value="{{ sample.received_date|date:'d.m.Y' }}" readonly></td>
            </tr>
            <tr>
                <td><i class="bi bi-box-seam"></i> Наименование материала:</td>
                <td><input type="text" value="Эмульсия" readonly></td>
            </tr>
            <tr>
                <td><i class="bi bi-truck"></i> Поставщик материала:</td>
                <td><input type="text" value="{{ sample.supplier }}" readonly></td>
            </tr>
            <tr>
                <td><i class="bi bi-layers"></i> Наименование смеси:</td>
                <td><input type="text" value="{% if sample.mix %}{{ sample.mix.name }}{% else %}ЭБДК В{% endif %}" readonly></td>
            </tr>
            <tr>
                <td><i class="bi bi-building"></i> Наименование объекта:</td>
                <td><input type="text" value="{{ sample.object_name }}" readonly></td>
            </tr>
        </table>
        
        <form method="post" action="{% url 'sample_test_form' sample.pk %}" id="emulsion-58952-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="save">
            <input type="hidden" id="mix-name" value="{% if sample.mix %}{{ sample.mix.name }}{% else %}ЭБДК В{% endif %}">
            <input type="hidden" id="current-apply-area" value="{{ test_result.apply_area|default:0 }}">
            
            <!-- ОБЛАСТЬ ПРИМЕНЕНИЯ -->
            <h2 class="measurement-section-title">
                <i class="bi bi-geo-alt"></i>
                Область применения
            </h2>
            <table class="data-table">
                <tbody>
                    <tr>
                        <td style="width: 50%;">Специальные области применения</td>
                        <td>
                            <select name="apply_area" id="apply_area" class="form-select-custom">
                                <!-- Опции будут заполнены через JavaScript -->
                            </select>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <!-- Скрытые поля для нормативов -->
            <input type="hidden" id="decay_index_min" value="50">
            <input type="hidden" id="decay_index_max" value="130">
            <input type="hidden" id="decay_index_range" value="50-130">
            <input type="hidden" id="binder_content_min" value="55">
            <input type="hidden" id="binder_content_max" value="65">
            <input type="hidden" id="remaining_max" value="0.25">
            <input type="hidden" id="remaining_after7_max" value="0.35">
            <input type="hidden" id="resistance_after7_max" value="1.0">
            
            <!-- ИНДЕКС РАСПАДА -->
            <h2 class="measurement-section-title">
                <i class="bi bi-water"></i>
                Индекс распада
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">Параметр</th>
                        <th>Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Масса чаши со шпателем, г</td>
                        <td><input type="number" step="0.01" name="decay_index_w1" id="decay_index_w1" value="{{ test_result.decay_index_w1|format_float }}"></td>
                    </tr>
                    <tr>
                        <td>Масса чаши со шпателем и с эмульсией, г</td>
                        <td><input type="number" step="0.01" name="decay_index_w2" id="decay_index_w2" value="{{ test_result.decay_index_w2|format_float }}"></td>
                    </tr>
                    <tr>
                        <td>Масса чаши со шпателем, эмульсией и кварцевым песком, г</td>
                        <td><input type="number" step="0.01" name="decay_index_w3" id="decay_index_w3" value="{{ test_result.decay_index_w3|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">Индекс распада</td>
                        <td><input type="number" step="0.01" name="decay_index_value" id="decay_index_value" value="{{ test_result.decay_index_value|format_float }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <!-- СОДЕРЖАНИЕ ВЯЖУЩЕГО С ЭМУЛЬГАТОРОМ -->
            <h2 class="measurement-section-title">
                <i class="bi bi-percent"></i>
                Содержание вяжущего с эмульгатором
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">Параметр</th>
                        <th>Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Масса чаши, г</td>
                        <td><input type="number" step="0.01" name="binder_content_w1" id="binder_content_w1" value="{{ test_result.binder_content_w1|format_float }}" onchange="if(window.emulsionCalculations) { window.emulsionCalculations.calculateBinderContent(); }"></td>
                    </tr>
                    <tr>
                        <td>Масса эмульсии, г</td>
                        <td><input type="number" step="0.01" name="binder_content_w2" id="binder_content_w2" value="{{ test_result.binder_content_w2|format_float }}" onchange="if(window.emulsionCalculations) { window.emulsionCalculations.calculateBinderContent(); }"></td>
                    </tr>
                    <tr>
                        <td>Масса чаши с эмульсией после выпаривания, г</td>
                        <td><input type="number" step="0.01" name="binder_content_w3" id="binder_content_w3" value="{{ test_result.binder_content_w3|format_float }}" onchange="if(window.emulsionCalculations) { window.emulsionCalculations.calculateBinderContent(); }"></td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">Содержание вяжущего с эмульгатором, %</td>
                        <td><input type="number" step="0.01" name="binder_content_value" id="binder_content_value" value="{{ test_result.binder_content_value|format_float }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <!-- ОСТАТОК НА СИТЕ 0,14 -->
            <h2 class="measurement-section-title">
                <i class="bi bi-funnel"></i>
                Остаток на сите 0,14
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">Параметр</th>
                        <th>Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Масса сита 0,14, г</td>
                        <td><input type="number" step="0.01" name="remaining_w1" id="remaining_w1" value="{{ test_result.remaining_w1|format_float }}" onchange="if(window.emulsionCalculations) window.emulsionCalculations.calculateRemaining();"></td>
                    </tr>
                    <tr>
                        <td>Масса стеклянного стакана, г</td>
                        <td><input type="number" step="0.01" name="remaining_w2" id="remaining_w2" value="{{ test_result.remaining_w2|format_float }}" onchange="if(window.emulsionCalculations) window.emulsionCalculations.calculateRemaining();"></td>
                    </tr>
                    <tr>
                        <td>Масса эмульсии, г</td>
                        <td><input type="number" step="0.01" name="remaining_w3" id="remaining_w3" value="{{ test_result.remaining_w3|format_float }}" onchange="if(window.emulsionCalculations) window.emulsionCalculations.calculateRemaining();"></td>
                    </tr>
                    <tr>
                        <td>Масса стакана с остатком эмульсии, г</td>
                        <td><input type="number" step="0.01" name="remaining_w4" id="remaining_w4" value="{{ test_result.remaining_w4|format_float }}" onchange="if(window.emulsionCalculations) window.emulsionCalculations.calculateRemaining();"></td>
                    </tr>
                    <tr>
                        <td>Масса сита 0,14 с остатком эмульсии после высушивания, г</td>
                        <td><input type="number" step="0.01" name="remaining_w5" id="remaining_w5" value="{{ test_result.remaining_w5|format_float }}" onchange="if(window.emulsionCalculations) window.emulsionCalculations.calculateRemaining();"></td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">Остаток на сите, %</td>
                        <td><input type="number" step="0.01" name="remaining_value" id="remaining_value" value="{{ test_result.remaining_value|format_float }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <!-- ОСТАТОК НА СИТЕ 0,14 ПОСЛЕ 7 СУТОК -->
            <h2 class="measurement-section-title">
                <i class="bi bi-calendar-week"></i>
                Остаток на сите 0,14 после 7 суток
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">Параметр</th>
                        <th>Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Масса сита 0,14, г</td>
                        <td><input type="number" step="0.01" name="remaining_after7_w1" id="remaining_after7_w1" value="{{ test_result.remaining_after7_w1|format_float }}"></td>
                    </tr>
                    <tr>
                        <td>Масса стеклянного стакана, г</td>
                        <td><input type="number" step="0.01" name="remaining_after7_w2" id="remaining_after7_w2" value="{{ test_result.remaining_after7_w2|format_float }}"></td>
                    </tr>
                    <tr>
                        <td>Масса эмульсии, г</td>
                        <td><input type="number" step="0.01" name="remaining_after7_w3" id="remaining_after7_w3" value="{{ test_result.remaining_after7_w3|format_float }}"></td>
                    </tr>
                    <tr>
                        <td>Масса стакана с остатком эмульсии, г</td>
                        <td><input type="number" step="0.01" name="remaining_after7_w4" id="remaining_after7_w4" value="{{ test_result.remaining_after7_w4|format_float }}"></td>
                    </tr>
                    <tr>
                        <td>Масса сита 0,14 с остатком эмульсии после высушивания, г</td>
                        <td><input type="number" step="0.01" name="remaining_after7_w5" id="remaining_after7_w5" value="{{ test_result.remaining_after7_w5|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">Остаток на сите, %</td>
                        <td><input type="number" step="0.01" name="remaining_after7_value" id="remaining_after7_value" value="{{ test_result.remaining_after7_value|format_float }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <!-- УСТОЙЧИВОСТЬ К РАССЛОЕНИЮ -->
            <h2 class="measurement-section-title">
                <i class="bi bi-layers"></i>
                Устойчивость к расслоению при хранении 7 суток
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Цилиндр</th>
                        <th>1</th>
                        <th>2</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Объем эмульсии</td>
                        <td><input type="number" step="0.01" name="resistance_cylinder1_volume" id="resistance_cylinder1_volume" value="{{ test_result.resistance_cylinder1_volume|format_float }}"></td>
                        <td><input type="number" step="0.01" name="resistance_cylinder2_volume" id="resistance_cylinder2_volume" value="{{ test_result.resistance_cylinder2_volume|format_float }}"></td>
                    </tr>
                    <tr>
                        <td>Отметка, до которой опустится эмульсия после 7 суток</td>
                        <td><input type="number" step="0.01" name="resistance_cylinder1_volume_after7" id="resistance_cylinder1_volume_after7" value="{{ test_result.resistance_cylinder1_volume_after7|format_float }}"></td>
                        <td><input type="number" step="0.01" name="resistance_cylinder2_volume_after7" id="resistance_cylinder2_volume_after7" value="{{ test_result.resistance_cylinder2_volume_after7|format_float }}"></td>
                    </tr>
                    <tr>
                        <td>Расслоение эмульсии, %</td>
                        <td><input type="number" step="0.01" name="resistance_cylinder1_delamination" id="resistance_cylinder1_delamination" value="{{ test_result.resistance_cylinder1_delamination|format_float }}" readonly></td>
                        <td><input type="number" step="0.01" name="resistance_cylinder2_delamination" id="resistance_cylinder2_delamination" value="{{ test_result.resistance_cylinder2_delamination|format_float }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            <table class="data-table">
                <tbody>
                    <tr>
                        <td style="width: 50%; font-weight: bold;">Устойчивость к расслоению (среднее), %</td>
                        <td><input type="number" step="0.01" name="resistance_after7_value" id="resistance_after7_value" value="{{ test_result.resistance_after7_value|format_float }}" readonly></td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">Допуск, % не более</td>
                        <td><input type="number" step="0.01" name="resistance_after7_max" id="resistance_after7_max" value="{{ test_result.resistance_after7_max|default:'1.0' }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <!-- АДГЕЗИЯ К МИНЕРАЛЬНОМУ МАТЕРИАЛУ -->
            <h2 class="measurement-section-title">
                <i class="bi bi-adhesive"></i>
                Адгезия к минеральному материалу
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">Параметр</th>
                        <th>Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Масса эмульсии, которую надо добавить к минеральному материалу, г</td>
                        <td>
                            <input type="number" step="0.01" name="mineral_material_adhesion" id="mineral_material_adhesion" value="{{ test_result.mineral_material_adhesion|format_float }}" readonly>
                            <button type="button" onclick="if(window.emulsionCalculations) { window.emulsionCalculations.calculateMineralMaterialAdhesion(); }" class="btn-calculate">
                                <i class="bi bi-calculator"></i> Пересчитать
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Характеристика пленки битумного вяжущего</th>
                        <th>
                            <select name="visual_quality" id="visual_quality" class="form-select-custom">
                                <option value="1" {% if test_result.visual_quality == 1 %}selected{% endif %}>Хорошо</option>
                                <option value="2" {% if test_result.visual_quality == 2 %}selected{% endif %}>Удовлетворительно</option>
                                <option value="3" {% if test_result.visual_quality == 3 %}selected{% endif %}>Неудовлетворительно</option>
                            </select>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Полное покрытие камней (пленка вяжущего может быть частично отдалена от острых краев и ребер)</td>
                        <td>Хорошо (Св. 90%)</td>
                    </tr>
                    <tr>
                        <td>Площадь покрытой поверхности превышает площадь непокрытой</td>
                        <td>Удовлетворительно (от 50% до 90% включительно)</td>
                    </tr>
                    <tr>
                        <td>Площадь непокрытой поверхности превышает площадь покрытой</td>
                        <td>Неудовлетворительно (менее 50%)</td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <!-- Buttons -->
            <div class="btn-container">
                <button type="submit" class="btn-save">
                    <i class="bi bi-save"></i>
                    Сохранить
                </button>
                <a href="{% url 'sample_list' %}" class="btn-cancel">
                    <i class="bi bi-arrow-left"></i>
                    Вернуться к списку
                </a>
                <button type="button" onclick="document.getElementById('debug-info').style.display='block'" class="btn-cancel btn-debug no-print">
                    <i class="bi bi-bug"></i>
                    Диагностика
                </button>
            </div>
        </form>
    </div>
    
    <!-- JavaScript для расчетов -->
    <script src="{% static 'js/emulsion_58952_calculations.js' %}"></script>
    
    <!-- JavaScript для управления областями применения -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== ИНИЦИАЛИЗАЦИЯ ФОРМЫ ЭМУЛЬСИИ ===');
            
            // Функция для установки опций области применения
            function initializeApplyAreaOptions() {
                const mixName = document.getElementById('mix-name').value;
                const applyAreaSelect = document.getElementById('apply_area');
                const currentValue = parseInt(document.getElementById('current-apply-area').value) || 0;
                
                console.log('Тип эмульсии:', mixName);
                console.log('Текущее значение области применения:', currentValue);
                
                // Очищаем текущие опции
                applyAreaSelect.innerHTML = '';
                
                // Определяем опции в зависимости от типа эмульсии
                let options = [];
                const normalizedName = mixName.toUpperCase().replace(/\s+/g, ' ').trim();
                
                if (normalizedName.includes('ЭБДК М') || normalizedName.includes('ЭБДК-М')) {
                    options = [
                        {value: 0, text: 'Общие'},
                        {value: 4, text: 'Рейсаклирование'},
                        {value: 5, text: 'ЛЭМС'}
                    ];
                    console.log('Установлены опции для ЭБДК М');
                } else if (normalizedName.includes('ЭБДК Б') || normalizedName.includes('ЭБДК-Б')) {
                    options = [
                        {value: 0, text: 'Общие'},
                        {value: 1, text: 'Подгрунтовка'},
                        {value: 2, text: 'Ямочный ремонт'},
                        {value: 3, text: 'ШПО'}
                    ];
                    console.log('Установлены опции для ЭБДК Б');
                } else if (normalizedName.includes('ЭБДК С') || normalizedName.includes('ЭБДК-С')) {
                    options = [
                        {value: 0, text: 'Общие'},
                        {value: 2, text: 'Ямочный ремонт'},
                        {value: 3, text: 'ШПО'}
                    ];
                    console.log('Установлены опции для ЭБДК С');
                } else {
                    // По умолчанию (для ЭБДК В и других)
                    options = [
                        {value: 0, text: 'Общие'},
                        {value: 1, text: 'Подгрунтовка'},
                        {value: 2, text: 'Ямочный ремонт'},
                        {value: 3, text: 'ШПО'}
                    ];
                    console.log('Установлены опции по умолчанию');
                }
                
                // Добавляем опции в select
                options.forEach(function(option) {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.text;
                    if (option.value === currentValue) {
                        opt.selected = true;
                    }
                    applyAreaSelect.appendChild(opt);
                });
                
                // Если текущее значение не найдено, выбираем первую опцию
                if (!applyAreaSelect.value && options.length > 0) {
                    applyAreaSelect.value = options[0].value;
                }
                
                console.log('Финальное значение области применения:', applyAreaSelect.value);
            }
            
            // Диагностика значений при загрузке
            function logCalculationDiagnostics() {
                console.log('=== ДИАГНОСТИКА РАСЧЕТА ОСТАТКА НА СИТЕ ===');
                const w1 = parseFloat(document.getElementById('remaining_w1')?.value) || 0;
                const w2 = parseFloat(document.getElementById('remaining_w2')?.value) || 0;
                const w3 = parseFloat(document.getElementById('remaining_w3')?.value) || 0;
                const w4 = parseFloat(document.getElementById('remaining_w4')?.value) || 0;
                const w5 = parseFloat(document.getElementById('remaining_w5')?.value) || 0;
                
                console.log('w1 (Масса сита 0,14):', w1);
                console.log('w2 (Масса стеклянного стакана):', w2);
                console.log('w3 (Масса эмульсии):', w3);
                console.log('w4 (Масса стакана с остатком эмульсии):', w4);
                console.log('w5 (Масса сита с остатком после высушивания):', w5);
                
                if (w1 && w2 && w3 && w4 && w5) {
                    const emulsionMass = w3 - (w4 - w2);
                    console.log('Масса использованной эмульсии = w3 - (w4 - w2) =', w3, '-', '(', w4, '-', w2, ') =', emulsionMass);
                    
                    if (emulsionMass !== 0) {
                        const result = ((w5 - w1) / emulsionMass) * 100;
                        console.log('Остаток = (w5 - w1) / emulsionMass * 100 =', '(', w5, '-', w1, ') /', emulsionMass, '* 100 =', result.toFixed(2), '%');
                    } else {
                        console.warn('⚠️ Масса использованной эмульсии = 0, деление на ноль!');
                    }
                    
                    if (emulsionMass < 0) {
                        console.error('❌ ОШИБКА: Масса использованной эмульсии отрицательная!');
                    }
                }
                console.log('=====================================');
            }
            
            // Инициализация
            initializeApplyAreaOptions();
            
            // Вызываем диагностику после небольшой задержки
            setTimeout(function() {
                logCalculationDiagnostics();
                
                // Проверяем загрузку основного JavaScript файла
                if (window.emulsionCalculations && typeof window.emulsionCalculations.calculateRemaining === 'function') {
                    console.log('✅ Функции расчета из emulsion_58952_calculations.js загружены');
                    
                    // Вручную привязываем обработчики событий для остатка на сите
                    ['remaining_w1', 'remaining_w2', 'remaining_w3', 'remaining_w4', 'remaining_w5'].forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.addEventListener('input', function() {
                                console.log('Вызываем calculateRemaining из-за изменения', id);
                                window.emulsionCalculations.calculateRemaining();
                            });
                            element.addEventListener('change', function() {
                                console.log('Вызываем calculateRemaining из-за изменения', id);
                                window.emulsionCalculations.calculateRemaining();
                            });
                        }
                    });
                    
                    // Вызываем расчет сразу
                    console.log('Выполняем начальный расчет остатка на сите');
                    window.emulsionCalculations.calculateRemaining();
                    
                } else {
                    console.error('❌ Функции расчета из emulsion_58952_calculations.js НЕ загружены!');
                    console.error('Проверьте подключение файла и наличие window.emulsionCalculations');
                }
            }, 500);
        });
    </script>
</body>
</html>
