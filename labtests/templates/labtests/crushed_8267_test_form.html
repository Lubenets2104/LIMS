{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лист измерений (Щебень {{ sample.mix.name }} по ГОСТ {{ sample.gost.number }})</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Modern Theme -->
    <link rel="stylesheet" href="{% static 'css/modern-theme.css' %}">
    <!-- Measurement Sheets -->
    <link rel="stylesheet" href="{% static 'css/measurement-sheets.css' %}">
    
    <style>
        .gost-requirements {
            background-color: rgba(0, 173, 181, 0.1);
            font-size: 0.9em;
        }
        
        .fraction-title {
            background-color: rgba(0, 173, 181, 0.2);
            font-weight: bold;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="measurement-container">
        <!-- Заголовок страницы -->
        <div class="measurement-header">
            <h1>
                <i class="bi bi-gem"></i>
                Лист измерений (Щебень {{ sample.mix.name }} по ГОСТ {{ sample.gost.number }})
            </h1>
            <p class="measurement-subtitle">
                Образец № {{ sample.sample_number }} | Дата: {{ sample.received_date|date:'d.m.Y' }}
            </p>
        </div>
        
        <!-- Информация об образце -->
        <table class="info-table">
            <tr>
                <td>Номер:</td>
                <td><input type="text" value="{{ sample.sample_number }}" readonly></td>
            </tr>
            <tr>
                <td>Дата отбора:</td>
                <td><input type="text" value="{{ sample.sampling_date|date:'d.m.Y' }}" readonly></td>
            </tr>
            <tr>
                <td>Заказчик:</td>
                <td><input type="text" value="{{ sample.customer }}" readonly></td>
            </tr>
            <tr>
                <td>Дата поступления в лабораторию:</td>
                <td><input type="text" value="{{ sample.received_date|date:'d.m.Y' }}" readonly></td>
            </tr>
            <tr>
                <td>Наименование материала:</td>
                <td><input type="text" value="Щебень" readonly></td>
            </tr>
            <tr>
                <td>Поставщик материала:</td>
                <td><input type="text" value="{{ sample.supplier }}" readonly></td>
            </tr>
            <tr>
                <td>Наименование смеси (фракция):</td>
                <td><input type="text" value="{{ sample.mix.name }}" readonly></td>
            </tr>
            <tr>
                <td>Наименование объекта:</td>
                <td><input type="text" value="{{ sample.object_name }}" readonly></td>
            </tr>
        </table>
        
        <form method="post" action="{% url 'sample_test_form' sample.pk %}" id="crushed-8267-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="save">
            <input type="hidden" name="fraction_type" id="fraction_type" value="{{ test_result.fraction_type }}">
            
            <!-- СОДЕРЖАНИЕ ПЫЛЕВИДНЫХ И ГЛИНИСТЫХ ЧАСТИЦ -->
            <h2 class="measurement-section-title">
                <i class="bi bi-cloud-drizzle"></i>
                Содержание пылевидных и глинистых частиц
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Параметр</th>
                        <th>Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса пробы до отмучивания, г</td>
                        <td><input type="number" step="0.1" name="dust_initial_weight" id="dust_initial_weight" value="{{ test_result.dust_initial_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса пробы после отмучивания, г</td>
                        <td><input type="number" step="0.1" name="dust_after_weight" id="dust_after_weight" value="{{ test_result.dust_after_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Содержание пылевидных и глинистых частиц, %</td>
                        <td><input type="number" step="0.01" name="dust_content" id="dust_content" value="{{ test_result.dust_content|format_float }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <!-- ГРАНУЛОМЕТРИЧЕСКИЙ СОСТАВ -->
            <h2 class="measurement-section-title">
                <i class="bi bi-funnel"></i>
                Гранулометрический состав
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Параметр</th>
                        <th>Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса пробы, г</td>
                        <td>
                            <input type="number" step="0.1" name="grain_compound_weight" id="grain_compound_weight" value="{{ test_result.grain_compound_weight|format_float }}">
                        </td>
                    </tr>
                </tbody>
            </table>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Размеры отверстий контрольных сит, мм</th>
                        <th>1.25D</th>
                        <th>D</th>
                        <th>(D+d)/2</th>
                        <th>d</th>
                        <th>d/2</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса остатка на сите, г</td>
                        <td><input type="number" step="0.1" name="partition_0_weight" id="partition_0_weight" value="{{ test_result.partition_0_weight|format_float }}"></td>
                        <td><input type="number" step="0.1" name="partition_1_weight" id="partition_1_weight" value="{{ test_result.partition_1_weight|format_float }}"></td>
                        <td><input type="number" step="0.1" name="partition_2_weight" id="partition_2_weight" value="{{ test_result.partition_2_weight|format_float }}"></td>
                        <td><input type="number" step="0.1" name="partition_3_weight" id="partition_3_weight" value="{{ test_result.partition_3_weight|format_float }}"></td>
                        <td><input type="number" step="0.1" name="partition_4_weight" id="partition_4_weight" value="{{ test_result.partition_4_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Частный остаток, % по массе</td>
                        <td><input type="number" step="0.1" name="partition_0_partial" id="partition_0_partial" value="{{ test_result.partition_0_partial|format_float }}" readonly></td>
                        <td><input type="number" step="0.1" name="partition_1_partial" id="partition_1_partial" value="{{ test_result.partition_1_partial|format_float }}" readonly></td>
                        <td><input type="number" step="0.1" name="partition_2_partial" id="partition_2_partial" value="{{ test_result.partition_2_partial|format_float }}" readonly></td>
                        <td><input type="number" step="0.1" name="partition_3_partial" id="partition_3_partial" value="{{ test_result.partition_3_partial|format_float }}" readonly></td>
                        <td><input type="number" step="0.1" name="partition_4_partial" id="partition_4_partial" value="{{ test_result.partition_4_partial|format_float }}" readonly></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Проходы через сито, % по массе</td>
                        <td><input type="number" step="0.1" name="partition_0_passes" id="partition_0_passes" value="{{ test_result.partition_0_passes|format_float }}" readonly></td>
                        <td><input type="number" step="0.1" name="partition_1_passes" id="partition_1_passes" value="{{ test_result.partition_1_passes|format_float }}" readonly></td>
                        <td><input type="number" step="0.1" name="partition_2_passes" id="partition_2_passes" value="{{ test_result.partition_2_passes|format_float }}" readonly></td>
                        <td><input type="number" step="0.1" name="partition_3_passes" id="partition_3_passes" value="{{ test_result.partition_3_passes|format_float }}" readonly></td>
                        <td><input type="number" step="0.1" name="partition_4_passes" id="partition_4_passes" value="{{ test_result.partition_4_passes|format_float }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            
            <!-- Требования ГОСТ -->
            <table class="data-table gost-requirements">
                <thead>
                    <tr>
                        <th colspan="9">Требования ГОСТ 8267-93 к полным остаткам на контрольных ситах</th>
                    </tr>
                    <tr>
                        <th rowspan="2">Фракция</th>
                        <th colspan="8">Диаметр отверстий контрольных сит, мм</th>
                    </tr>
                    <tr>
                        <th>d</th>
                        <th>0.5(d+D)</th>
                        <th>D</th>
                        <th>1.25D</th>
                        <th>Dнаиб</th>
                        <th colspan="3">Полные остатки на ситах, % по массе</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>5-10</td>
                        <td>2.5</td>
                        <td>-</td>
                        <td>5</td>
                        <td>10</td>
                        <td>12.5</td>
                        <td>до 5</td>
                        <td>90-100</td>
                        <td>до 0.5</td>
                    </tr>
                    <tr>
                        <td>10-20</td>
                        <td>5</td>
                        <td>-</td>
                        <td>10</td>
                        <td>20</td>
                        <td>25</td>
                        <td>до 5</td>
                        <td>90-100</td>
                        <td>до 0.5</td>
                    </tr>
                    <tr>
                        <td>20-40</td>
                        <td>10</td>
                        <td>-</td>
                        <td>20</td>
                        <td>40</td>
                        <td>50</td>
                        <td>до 5</td>
                        <td>90-100</td>
                        <td>до 0.5</td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <!-- ЛЕЩАДНОСТЬ -->
            <h2 class="measurement-section-title">
                <i class="bi bi-triangle"></i>
                Содержание зерен пластинчатой (лещадной) и игловатой формы
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Параметр</th>
                        <th>Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса пробы, г</td>
                        <td><input type="number" step="0.1" name="flakiness_weight" id="flakiness_weight" value="{{ test_result.flakiness_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса лещадных зерен, г</td>
                        <td><input type="number" step="0.1" name="flakiness_flaky_weight" id="flakiness_flaky_weight" value="{{ test_result.flakiness_flaky_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Лещадность, %</td>
                        <td><input type="number" step="0.01" name="flakiness_value" id="flakiness_value" value="{{ test_result.flakiness_value|format_float }}" readonly></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Группа щебня по лещадности</td>
                        <td><input type="text" name="flakiness_mark_type" id="flakiness_mark_type" value="{{ test_result.flakiness_mark_type }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <!-- ДРОБИМОСТЬ -->
            <h2 class="measurement-section-title">
                <i class="bi bi-hammer"></i>
                Дробимость
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Параметр</th>
                        <th>Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Вид породы</td>
                        <td>
                            <select name="crushability_type" id="crushability_type">
                                <option value="0" {% if test_result.crushability_type == 0 %}selected{% endif %}>Изверженные и метаморфические горные породы</option>
                                <option value="1" {% if test_result.crushability_type == 1 %}selected{% endif %}>Осадочные горные породы</option>
                                <option value="2" {% if test_result.crushability_type == 2 %}selected{% endif %}>Щебень из гравия и гравий</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса пробы, г</td>
                        <td><input type="number" step="0.1" name="crushability_weight" id="crushability_weight" value="{{ test_result.crushability_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса зерен оставшихся на контрольном сите после дробления, г</td>
                        <td><input type="number" step="0.1" name="crushability_after_weight" id="crushability_after_weight" value="{{ test_result.crushability_after_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Дробимость, %</td>
                        <td><input type="number" step="0.01" name="crushability_value" id="crushability_value" value="{{ test_result.crushability_value|format_float }}" readonly></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Марка по дробимости</td>
                        <td><input type="text" name="crushability_mark_type" id="crushability_mark_type" value="{{ test_result.crushability_mark_type }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <!-- НАСЫПНАЯ ПЛОТНОСТЬ -->
            <h2 class="measurement-section-title">
                <i class="bi bi-speedometer"></i>
                Насыпная плотность
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Параметр</th>
                        <th colspan="2">Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Объем сосуда, см³</td>
                        <td><input type="number" step="0.1" name="bulk_density_0_volume" id="bulk_density_0_volume" value="{{ test_result.bulk_density_0_volume|format_float }}"></td>
                        <td><input type="number" step="0.1" name="bulk_density_1_volume" id="bulk_density_1_volume" value="{{ test_result.bulk_density_1_volume|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса пустого сосуда, г</td>
                        <td><input type="number" step="0.1" name="bulk_density_0_empty_weight" id="bulk_density_0_empty_weight" value="{{ test_result.bulk_density_0_empty_weight|format_float }}"></td>
                        <td><input type="number" step="0.1" name="bulk_density_1_empty_weight" id="bulk_density_1_empty_weight" value="{{ test_result.bulk_density_1_empty_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса сосуда с пробой, г</td>
                        <td><input type="number" step="0.1" name="bulk_density_0_weight" id="bulk_density_0_weight" value="{{ test_result.bulk_density_0_weight|format_float }}"></td>
                        <td><input type="number" step="0.1" name="bulk_density_1_weight" id="bulk_density_1_weight" value="{{ test_result.bulk_density_1_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Насыпная плотность, г/см³</td>
                        <td><input type="number" step="0.01" name="bulk_density_0_density_value" id="bulk_density_0_density_value" value="{{ test_result.bulk_density_0_density_value|format_float }}" readonly></td>
                        <td><input type="number" step="0.01" name="bulk_density_1_density_value" id="bulk_density_1_density_value" value="{{ test_result.bulk_density_1_density_value|format_float }}" readonly></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Средняя насыпная плотность, г/см³</td>
                        <td colspan="2"><input type="number" step="0.01" name="bulk_density_average" id="bulk_density_average" value="{{ test_result.bulk_density_average|format_float }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <!-- СОДЕРЖАНИЕ ЗЕРЕН СЛАБЫХ ПОРОД -->
            <h2 class="measurement-section-title">
                <i class="bi bi-exclamation-triangle"></i>
                Содержание зерен слабых пород
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Параметр</th>
                        <th>Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса начальная, г</td>
                        <td><input type="number" step="0.1" name="weak_rock_initial_weight" id="weak_rock_initial_weight" value="{{ test_result.weak_rock_initial_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса слабых зерен, г</td>
                        <td><input type="number" step="0.1" name="weak_rock_weight" id="weak_rock_weight" value="{{ test_result.weak_rock_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Содержание, %</td>
                        <td><input type="number" step="0.01" name="weak_rock_content" id="weak_rock_content" value="{{ test_result.weak_rock_content|format_float }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <!-- СОДЕРЖАНИЕ ГЛИНЫ В КОМКАХ -->
            <h2 class="measurement-section-title">
                <i class="bi bi-droplet"></i>
                Содержание глины в комках
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Параметр</th>
                        <th>Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса пробы, г</td>
                        <td><input type="number" step="0.1" name="clay_initial_weight" id="clay_initial_weight" value="{{ test_result.clay_initial_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса глины в комках, г</td>
                        <td><input type="number" step="0.1" name="clay_weight" id="clay_weight" value="{{ test_result.clay_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Содержание глины в комках, %</td>
                        <td><input type="number" step="0.01" name="clay_content" id="clay_content" value="{{ test_result.clay_content|format_float }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <!-- СРЕДНЯЯ ПЛОТНОСТЬ -->
            <h2 class="measurement-section-title">
                <i class="bi bi-speedometer2"></i>
                Средняя плотность
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Параметр</th>
                        <th>Значение</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса высушенной пробы, г</td>
                        <td><input type="number" step="0.1" name="average_density_dried_weight" id="average_density_dried_weight" value="{{ test_result.average_density_dried_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса пробы в насыщенном водой состоянии на воздухе, г</td>
                        <td><input type="number" step="0.1" name="average_density_weight_in_air" id="average_density_weight_in_air" value="{{ test_result.average_density_weight_in_air|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса корзины и пробы в насыщенном водой состоянии в воде, г</td>
                        <td><input type="number" step="0.1" name="average_density_weight_in_water" id="average_density_weight_in_water" value="{{ test_result.average_density_weight_in_water|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Масса пустой корзины, г</td>
                        <td><input type="number" step="0.1" name="average_density_empty_basket_weight" id="average_density_empty_basket_weight" value="{{ test_result.average_density_empty_basket_weight|format_float }}"></td>
                    </tr>
                    <tr>
                        <td style="text-align: left; font-weight: bold;">Средняя плотность</td>
                        <td><input type="number" step="0.01" name="average_density_value" id="average_density_value" value="{{ test_result.average_density_value|format_float }}" readonly></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-footer">Испытания провел(а): _____________</div>
            
            <div class="btn-container">
                <button type="submit" class="btn-save">
                    <i class="bi bi-save"></i>
                    Сохранить
                </button>
            </div>
        </form>
    </div>
    
    <!-- JavaScript для расчетов -->
    <script src="{% static 'js/crushed_8267_calculations.js' %}"></script>
    
    <!-- Inline JavaScript как резервный вариант -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Inline script загружен');
        
        // === ГРАНУЛОМЕТРИЧЕСКИЙ СОСТАВ ===
        function calculateGrainComposition() {
            console.log('Расчет гранулометрического состава');
            const totalWeight = parseFloat(document.getElementById('grain_compound_weight')?.value) || 0;
            
            if (totalWeight <= 0) {
                return;
            }
            
            let cumulativePasses = 0;
            
            for (let i = 0; i < 5; i++) {
                const weightField = document.getElementById(`partition_${i}_weight`);
                const partialField = document.getElementById(`partition_${i}_partial`);
                const passesField = document.getElementById(`partition_${i}_passes`);
                
                if (weightField && partialField && passesField) {
                    const weight = parseFloat(weightField.value) || 0;
                    
                    // Частный остаток
                    const partial = (weight / totalWeight * 100).toFixed(1);
                    partialField.value = partial;
                    
                    // Проходы через сито
                    cumulativePasses += parseFloat(partial);
                    passesField.value = cumulativePasses.toFixed(1);
                }
            }
        }
        
        // === НАСЫПНАЯ ПЛОТНОСТЬ ===
        function calculateBulkDensity() {
            console.log('Расчет насыпной плотности');
            
            // Для первой пробы
            const volume0 = parseFloat(document.getElementById('bulk_density_0_volume')?.value) || 0;
            const empty0 = parseFloat(document.getElementById('bulk_density_0_empty_weight')?.value) || 0;
            const weight0 = parseFloat(document.getElementById('bulk_density_0_weight')?.value) || 0;
            
            if (volume0 > 0 && weight0 > empty0) {
                const density0 = ((weight0 - empty0) / volume0).toFixed(2);
                const field0 = document.getElementById('bulk_density_0_density_value');
                if (field0) field0.value = density0;
            }
            
            // Для второй пробы
            const volume1 = parseFloat(document.getElementById('bulk_density_1_volume')?.value) || 0;
            const empty1 = parseFloat(document.getElementById('bulk_density_1_empty_weight')?.value) || 0;
            const weight1 = parseFloat(document.getElementById('bulk_density_1_weight')?.value) || 0;
            
            if (volume1 > 0 && weight1 > empty1) {
                const density1 = ((weight1 - empty1) / volume1).toFixed(2);
                const field1 = document.getElementById('bulk_density_1_density_value');
                if (field1) field1.value = density1;
            }
            
            // Средняя плотность
            const density0Val = parseFloat(document.getElementById('bulk_density_0_density_value')?.value) || 0;
            const density1Val = parseFloat(document.getElementById('bulk_density_1_density_value')?.value) || 0;
            
            if (density0Val > 0 && density1Val > 0) {
                const avgDensity = ((density0Val + density1Val) / 2).toFixed(2);
                const avgField = document.getElementById('bulk_density_average');
                if (avgField) avgField.value = avgDensity;
            }
        }
        
        // === СОДЕРЖАНИЕ ЗЕРЕН СЛАБЫХ ПОРОД ===
        function calculateWeakRock() {
            console.log('Расчет содержания слабых пород');
            const initialWeight = parseFloat(document.getElementById('weak_rock_initial_weight')?.value) || 0;
            const weakWeight = parseFloat(document.getElementById('weak_rock_weight')?.value) || 0;
            
            if (initialWeight > 0) {
                const content = ((initialWeight - weakWeight) / initialWeight * 100).toFixed(1);
                const contentField = document.getElementById('weak_rock_content');
                if (contentField) contentField.value = content;
            }
        }
        
        // === СОДЕРЖАНИЕ ГЛИНЫ В КОМКАХ ===
        function calculateClayContent() {
            console.log('Расчет содержания глины');
            const initialWeight = parseFloat(document.getElementById('clay_initial_weight')?.value) || 0;
            const clayWeight = parseFloat(document.getElementById('clay_weight')?.value) || 0;
            
            if (initialWeight > 0) {
                const content = (clayWeight / initialWeight * 100).toFixed(2);
                const contentField = document.getElementById('clay_content');
                if (contentField) contentField.value = content;
            }
        }
        
        // === СРЕДНЯЯ ПЛОТНОСТЬ ===
        function calculateAverageDensity() {
            console.log('Расчет средней плотности');
            const driedWeight = parseFloat(document.getElementById('average_density_dried_weight')?.value) || 0;
            const weightInAir = parseFloat(document.getElementById('average_density_weight_in_air')?.value) || 0;
            const weightInWater = parseFloat(document.getElementById('average_density_weight_in_water')?.value) || 0;
            const emptyBasket = parseFloat(document.getElementById('average_density_empty_basket_weight')?.value) || 0;
            
            if (driedWeight > 0 && weightInAir > 0 && weightInWater > 0) {
                const denominator = weightInAir - (weightInWater - emptyBasket);
                if (denominator > 0) {
                    const density = (driedWeight / denominator).toFixed(2);
                    const densityField = document.getElementById('average_density_value');
                    if (densityField) densityField.value = density;
                }
            }
        }
        
        // === ПЫЛЕВИДНЫЕ И ГЛИНИСТЫЕ ЧАСТИЦЫ ===
        function calculateDustContent() {
            console.log('Расчет пылевидных частиц');
            const initialWeight = parseFloat(document.getElementById('dust_initial_weight')?.value) || 0;
            const afterWeight = parseFloat(document.getElementById('dust_after_weight')?.value) || 0;
            
            if (initialWeight > 0) {
                const content = ((initialWeight - afterWeight) / initialWeight * 100).toFixed(1);
                const contentField = document.getElementById('dust_content');
                if (contentField) contentField.value = content;
            }
        }
        function calculateFlakiness() {
            console.log('Расчет лещадности');
            const weight = parseFloat(document.getElementById('flakiness_weight')?.value) || 0;
            const flakyWeight = parseFloat(document.getElementById('flakiness_flaky_weight')?.value) || 0;
            
            if (weight > 0) {
                const flakiness = (flakyWeight / weight * 100).toFixed(2);
                const flakinessField = document.getElementById('flakiness_value');
                if (flakinessField) {
                    flakinessField.value = flakiness;
                }
                
                // Определение группы
                const markField = document.getElementById('flakiness_mark_type');
                if (markField) {
                    let group = '';
                    const value = parseFloat(flakiness);
                    
                    if (value <= 10) group = 'I';
                    else if (value <= 15) group = 'II';
                    else if (value <= 25) group = 'III';
                    else if (value <= 35) group = 'IV';
                    else if (value <= 50) group = 'V';
                    else group = 'None';
                    
                    markField.value = group;
                }
            }
        }
        
        // === ДРОБИМОСТЬ ===
        function calculateCrushability() {
            console.log('Расчет дробимости');
            const weight = parseFloat(document.getElementById('crushability_weight')?.value) || 0;
            const afterWeight = parseFloat(document.getElementById('crushability_after_weight')?.value) || 0;
            const type = parseInt(document.getElementById('crushability_type')?.value) || 0;
            
            if (weight > 0 && afterWeight >= 0) {
                const crushability = ((weight - afterWeight) / weight * 100).toFixed(2);
                const crushabilityField = document.getElementById('crushability_value');
                if (crushabilityField) {
                    crushabilityField.value = crushability;
                }
                
                // Определение марки
                const markField = document.getElementById('crushability_mark_type');
                if (markField) {
                    let mark = '';
                    const value = parseFloat(crushability);
                    
                    if (type === 0) { // Изверженные и метаморфические
                        if (value <= 12) mark = '1400';
                        else if (value <= 16) mark = '1200';
                        else if (value <= 20) mark = '1000';
                        else if (value <= 25) mark = '800';
                        else if (value <= 34) mark = '600';
                        else if (value <= 42) mark = '400';
                        else if (value <= 50) mark = '300';
                        else mark = '200';
                    } else if (type === 1) { // Осадочные
                        if (value <= 10) mark = '1200';
                        else if (value <= 14) mark = '1000';
                        else if (value <= 18) mark = '800';
                        else if (value <= 26) mark = '600';
                        else if (value <= 34) mark = '400';
                        else if (value <= 42) mark = '300';
                        else mark = '200';
                    } else if (type === 2) { // Щебень из гравия и гравий
                        if (value <= 10) mark = '1000';
                        else if (value <= 15) mark = '800';
                        else if (value <= 20) mark = '600';
                        else if (value <= 25) mark = '400';
                        else mark = '200';
                    }
                    
                    markField.value = mark;
                }
            }
        }
        
        // Привязка обработчиков для гранулометрического состава
        const grainWeight = document.getElementById('grain_compound_weight');
        if (grainWeight) {
            grainWeight.addEventListener('input', calculateGrainComposition);
            grainWeight.addEventListener('change', calculateGrainComposition);
        }
        
        for (let i = 0; i < 5; i++) {
            const partitionWeight = document.getElementById(`partition_${i}_weight`);
            if (partitionWeight) {
                partitionWeight.addEventListener('input', calculateGrainComposition);
                partitionWeight.addEventListener('change', calculateGrainComposition);
            }
        }
        
        // Привязка обработчиков для лещадности
        const flakinessWeight = document.getElementById('flakiness_weight');
        const flakinessFlaky = document.getElementById('flakiness_flaky_weight');
        
        if (flakinessWeight) {
            flakinessWeight.addEventListener('input', calculateFlakiness);
        }
        if (flakinessFlaky) {
            flakinessFlaky.addEventListener('input', calculateFlakiness);
        }
        
        // Привязка обработчиков для дробимости
        const crushWeight = document.getElementById('crushability_weight');
        const crushAfter = document.getElementById('crushability_after_weight');
        const crushType = document.getElementById('crushability_type');
        
        if (crushWeight) {
            crushWeight.addEventListener('input', calculateCrushability);
        }
        if (crushAfter) {
            crushAfter.addEventListener('input', calculateCrushability);
        }
        if (crushType) {
            crushType.addEventListener('change', calculateCrushability);
        }
        
        // Привязка обработчиков для пылевидных частиц
        const dustInitial = document.getElementById('dust_initial_weight');
        const dustAfter = document.getElementById('dust_after_weight');
        if (dustInitial) dustInitial.addEventListener('input', calculateDustContent);
        if (dustAfter) dustAfter.addEventListener('input', calculateDustContent);
        
        // Привязка обработчиков для насыпной плотности
        ['bulk_density_0_volume', 'bulk_density_0_empty_weight', 'bulk_density_0_weight',
         'bulk_density_1_volume', 'bulk_density_1_empty_weight', 'bulk_density_1_weight'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.addEventListener('input', calculateBulkDensity);
        });
        
        // Привязка обработчиков для слабых пород
        const weakInitial = document.getElementById('weak_rock_initial_weight');
        const weakWeight = document.getElementById('weak_rock_weight');
        if (weakInitial) weakInitial.addEventListener('input', calculateWeakRock);
        if (weakWeight) weakWeight.addEventListener('input', calculateWeakRock);
        
        // Привязка обработчиков для глины в комках
        const clayInitial = document.getElementById('clay_initial_weight');
        const clayWt = document.getElementById('clay_weight');
        if (clayInitial) clayInitial.addEventListener('input', calculateClayContent);
        if (clayWt) clayWt.addEventListener('input', calculateClayContent);
        
        // Привязка обработчиков для средней плотности
        ['average_density_dried_weight', 'average_density_weight_in_air', 
         'average_density_weight_in_water', 'average_density_empty_basket_weight'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.addEventListener('input', calculateAverageDensity);
        });
        
        // Запуск всех расчетов при загрузке
        calculateDustContent();
        calculateGrainComposition();
        calculateFlakiness();
        calculateCrushability();
        calculateBulkDensity();
        calculateWeakRock();
        calculateClayContent();
        calculateAverageDensity();
        
        console.log('Все обработчики привязаны');
    });
    </script>
</body>
</html>
